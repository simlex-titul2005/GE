@model SxVMProjectStep[]
@{
    ViewBag.Title = "Развитие проекта";
}

@section styles{
    <link href="~/content/dist/css/ps-tree.min.css" rel="stylesheet" />
}

<h2>@ViewBag.Title</h2>
<div class="text-right">
    <a class="btn btn-default" href="/projectsteps/edit">Создать</a>
</div>
<br />
@if (Model.Any())
{
    @Html.SxTree(Model, new SxExtantions.SxTreeSettings<SxVMProjectStep>
{
    FuncChildren = (s) => { return s.Steps; },
    FuncContent = (s) => { return Html.DisplayFor(x => s).ToString(); }
}, new { @class = "ps-tree" })
}

@section scripts{
    <script type="text/javascript">
        $(function () {
            $('.btns a').on('click', function () {
                replaceOrder(this);
            });
        });

        function replaceOrder(step) {
            $step = $(step);
            $li = $step.closest('.panel').closest('li');
            var osid = $step.closest('.panel').data('o-id');
            var id = $step.closest('.panel').attr('id').replace('pstep-', '');
            var dir = $step.data('dir') == 'up' ? true : false;
            $.ajax({
                method: 'post',
                url: '/projectsteps/replaceorder',
                data: { id: id, osid: osid, dir: dir },
                success: function (data) {
                    if (dir) {
                        $prevli = $li.prev('li');
                        if ($prevli.length == 1) {
                            var oldhtml = $prevli.html();
                            $prevli.html($li.html());
                            $li.html(oldhtml);
                        }
                    }
                    else {
                        $nextli = $li.next('li');
                        if ($nextli.length == 1) {
                            var oldhtml = $nextli.html();
                            $nextli.html($li.html());
                            $li.html(oldhtml);
                        }
                    }
                }
            });
        }

        function fillProjectStepHtml(s) {
            $a = $(s);
            var id = $a.data("id");
            $.ajax({
                method: 'post',
                url: '/projectsteps/fillhtml',
                data: { id: id },
                beforeSend: function () {
                    $('.ps-tree .html').remove();
                },
                success: function (data) {
                    var html = $('<div class="html"></div>').append(data);
                    $a.closest('div').append(html);
                }
            });
        }
    </script>
}

